<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FICHE INCIDENTS - HITS BOULOGNE</title>

<!-- html2pdf (inclut jsPDF + html2canvas) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" crossorigin="anonymous"></script>
<!-- PDF.js pour convertir les PDF joints en images -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>
  if (window['pdfjsLib']) {
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
  }
</script>

<style>
  :root{
    --page-w: 210mm;
    --pad: 14mm;
    --theme:#1a2d4a; --txt:#0b1320; --bg:#e9ebee; --radius:12px;
    --toolbar-h:0px;
  }
  *{ box-sizing:border-box; }
  html { -webkit-text-size-adjust: 100%; }
  html,body{ margin:0; background:var(--bg); color:var(--txt); font-family:Arial, Helvetica, sans-serif; }

  .page-wrapper{ display:flex; justify-content:center; padding:16px; padding-bottom:calc(16px + var(--toolbar-h) + env(safe-area-inset-bottom)); }
  .page{ width:min(100%, var(--page-w)); background:#fff; border-radius:var(--radius); box-shadow:0 10px 28px rgba(0,0,0,.1); padding:var(--pad); display:flex; flex-direction:column; gap:12px; }
  .no-break{ break-inside:avoid; page-break-inside:avoid; }

  .header{ display:flex; align-items:center; gap:12px; }
  .header img{ width:54px; height:auto; }
  .header strong{ display:block; font-size:16px; }

  .title{ border:2px solid #0f1a2d20; border-radius:10px; text-align:center; font-weight:800; letter-spacing:.4px; padding:8px 10px; margin-top:2px; }

  table.grid{ width:100%; border-collapse:collapse; font-size:14px; table-layout:auto; }
  .grid td{ padding:6px 6px; vertical-align:middle; min-width:0; }
  .label{ font-weight:700; white-space:nowrap; }

  input[type="text"], input[type="date"], textarea{
    width:100%; border:1.5px solid #c9ced6; border-radius:10px; padding:10px 12px; font-size:15px;
  }
  input::placeholder, textarea::placeholder{ color:#9aa3ad; }
  textarea{ min-height:110px; resize:vertical; overflow-wrap:anywhere; word-break:break-word; line-height:1.35; }
  textarea.autogrow{ overflow:hidden; }

  .section-h{ background:var(--theme); color:#fff; font-weight:800; letter-spacing:.3px; padding:8px 10px; border-radius:10px; }
  .section-b{ border:1.5px solid #c9ced6; border-radius:12px; padding:12px; }

  .row{ display:flex; align-items:center; flex-wrap:wrap; gap:10px; margin-bottom:8px; }
  .sub{ display:none; gap:8px; align-items:center; }

  .signatures{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
  .sig-box label{ font-weight:700; display:block; margin-bottom:6px; }
  .sig-wrap{ position:relative; width:100%; height:140px; border:1.5px dashed #b6bcc6; border-radius:12px; background:#fff; touch-action:none; }
  canvas.signature{ width:100%; height:140px; display:block; touch-action:none; }
  .sig-hint{ position:absolute; top:8px; right:12px; font-size:12px; color:#7a8592; }
  .sig-actions{ text-align:right; margin-top:6px; }
  .btn-mini{ font-size:13px; padding:7px 12px; border:none; background:#404b57; color:#fff; border-radius:10px; }

  .made-row{ display:flex; align-items:center; gap:10px; flex-wrap:nowrap; }
  /* Champ "Fait le" plus √©troit */
  .made-row input[type="date"]{ width:140px; max-width:40vw; flex:0 0 auto; }
  .made-row .city{ white-space:nowrap; }

  /* Pi√®ces jointes + croix */
  .attach-box{ border:1.5px dashed #b6bcc6; border-radius:12px; padding:12px; background:#fafbfc; }
  .attach-previews{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
  .attach-previews .thumb{
    position:relative; width:120px; height:90px; border:1px solid #cbd3db; border-radius:10px;
    overflow:hidden; background:#fff; display:flex; align-items:center; justify-content:center;
  }
  .attach-previews .thumb img{ max-width:100%; max-height:100%; display:block; }
  .attach-previews .pdfbadge{ font-size:12px; font-weight:700; color:#c12222; }
  .attach-previews .remove{
    position:absolute; top:6px; right:6px; width:22px; height:22px; border-radius:50%;
    border:none; background:#000; color:#fff; font-weight:800; line-height:22px; text-align:center; cursor:pointer;
  }

  /* Toolbar */
  .toolbar{ position:fixed; left:0; right:0; bottom:0; z-index:9999; }
  .toolbar-inner{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; background:#fff; border-top:1px solid #0001; padding:10px; padding-bottom:calc(10px + env(safe-area-inset-bottom)); box-shadow:0 -8px 22px rgba(0,0,0,.06); }
  .btn{ background:#000; color:#fff; border:none; border-radius:12px; padding:12px 16px; font-weight:800; cursor:pointer; font-size:15px; box-shadow:0 4px 10px rgba(0,0,0,.2); }
  .btn.link{ background:transparent; color:#000; border:1.5px dashed #111; }
  .btn[disabled]{ opacity:.55; cursor:not-allowed; }
  @media (max-width:768px), (max-device-width:768px){ .btn-print{ display:none!important; } }

  #loader{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.35); z-index:10000; color:#fff; font:600 16px/1.2 Arial, sans-serif; }
  #loader .box{ background:#111; padding:14px 18px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,.4); }

  #toast{ position:fixed; left:50%; bottom:calc(var(--toolbar-h) + 16px + env(safe-area-inset-bottom)); transform:translateX(-50%); background:#111; color:#fff; padding:12px 16px; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.25); display:none; z-index:10001; font-weight:700; white-space:pre-line; }

  @media (max-width:768px){
    .grid tr{ display:block; }
    .grid td{ display:block; width:100%; padding:6px 4px; }
    .grid .label{ margin-bottom:4px; white-space:normal; line-height:1.25; word-break:break-word; }
    .grid tr:first-child{ display:grid!important; grid-template-columns:minmax(0,1fr) minmax(0,1fr); column-gap:12px; align-items:end; }
    .grid tr:first-child td:nth-child(1), .grid tr:first-child td:nth-child(2){ grid-column:1; }
    .grid tr:first-child td:nth-child(3), .grid tr:first-child td:nth-child(4){ grid-column:2; }
    .grid tr:first-child td{ min-width:0; }
    .grid tr:first-child td:nth-child(3){ font-size:15px; }
    #salarie, #salarie::placeholder{ font-size:16px; }
    input[type="text"], input[type="date"], textarea{ width:100%; min-height:42px; font-size:15px; padding:10px 12px; }
    .signatures{ grid-template-columns:1fr 1fr; }
  }

  @media print{ .toolbar{ display:none!important; } body{ background:#fff; } }
</style>
</head>
<body>
  <!-- Toolbar -->
  <div class="toolbar no-print" id="toolbar">
    <div class="toolbar-inner">
      <button id="btnPrint" class="btn btn-print" onclick="window.print()">üñ®Ô∏è Imprimer manuellement ordi</button>
      <button id="sendBtn" class="btn" onclick="sendToServer()">üì® Envoyer</button>
      <button id="autoSaveBtn" class="btn link" style="display:none">üíæ Sauvegarde auto : ON</button>
      <button class="btn link" onclick="clearAll()">üßπ Effacer tout</button>
    </div>
  </div>

  <div id="loader"><div class="box">‚è≥ G√©n√©ration & envoi en cours‚Ä¶</div></div>
  <div id="toast"></div>

  <!-- Page -->
  <div class="page-wrapper">
    <div class="page" id="pageContent">
      <div class="header no-break">
        <img src="logo_otacos.png" alt="O'Tacos">
        <div><strong>HITS BOULOGNE</strong>O‚Äôtacos Boulogne-sur-Mer</div>
      </div>

      <div class="title no-break">FICHE INCIDENTS</div>

      <table class="grid no-break" role="presentation">
        <tr>
          <td class="label">Date :</td>
          <td><input type="date" id="date_fiche" autocomplete="off" placeholder="jj/mm/aaaa"></td>
          <td class="label" style="text-align:right;">Fiche ouverte pour :</td>
          <td><input type="text" id="salarie" placeholder="Nom de l‚Äô√©quipier" autocomplete="name"></td>
        </tr>
        <tr>
          <td class="label">Responsable :</td>
          <td colspan="3"><input type="text" id="responsable" placeholder="Responsable" autocomplete="name"></td>
        </tr>
      </table>

      <div class="section-h no-break">DESCRIPTIF DE L‚ÄôINCIDENT</div>
      <div class="section-b no-break">
        <div class="row">
          <input type="checkbox" id="abs_prev"><label for="abs_prev"><strong>Absence pr√©vue le :</strong></label>
          <div class="sub" id="abs_prev_fields">
            <input type="date" id="abs_prev_date" placeholder="jj/mm/aaaa" />
            <span>Shift pr√©vu √† :</span>
            <input type="text" id="abs_prev_shift" placeholder="ex: 18h" inputmode="text" style="width:100px">
          </div>
        </div>

        <div class="row">
          <input type="checkbox" id="abs_np"><label for="abs_np"><strong>Absence non pr√©vue le :</strong></label>
          <div class="sub" id="abs_np_fields">
            <input type="date" id="abs_np_date" placeholder="jj/mm/aaaa" />
            <span>Shift pr√©vu √† :</span>
            <input type="text" id="abs_np_shift" placeholder="ex: 18h" inputmode="text" style="width:100px">
          </div>
        </div>

        <div class="row">
          <input type="checkbox" id="ret_prev"><label for="ret_prev"><strong>Retard pr√©vu de :</strong></label>
          <div class="sub" id="ret_prev_fields">
            <input type="text" id="ret_prev_duree" placeholder="ex: 30 min" inputmode="text" style="width:120px">
          </div>
        </div>

        <div class="row">
          <input type="checkbox" id="ret_np"><label for="ret_np"><strong>Retard non pr√©vu de :</strong></label>
          <div class="sub" id="ret_np_fields">
            <input type="text" id="ret_np_duree" placeholder="ex: 20 min" inputmode="text" style="width:120px">
          </div>
        </div>

        <div class="row">
          <input type="checkbox" id="autre"><label for="autre"><strong>Autre :</strong></label>
          <div class="sub" id="autre_fields">
            <input type="text" id="autre_detail" placeholder="Pr√©ciser‚Ä¶" style="min-width:220px; flex:1">
          </div>
        </div>
      </div>

      <div class="section-h no-break">ORIGINE DE L‚ÄôINCIDENT</div>
      <div class="section-b no-break">
        <textarea id="origine" placeholder="D√©crire l'origine‚Ä¶"></textarea>
      </div>

      <div class="section-h no-break">ACTION CURATIVE</div>
      <div class="section-b no-break">
        <textarea id="action" placeholder="D√©crire l'action corrective‚Ä¶"></textarea>
      </div>

      <div class="no-break made-row" style="font-size:14px;">
        <strong>Fait le :</strong>
        <input type="date" id="fait_le" placeholder="jj/mm/aaaa">
        <span class="city">, √† Boulogne-sur-Mer</span>
      </div>

      <div class="signatures no-break">
        <div class="sig-box">
          <label for="signRespCanvas">Signature Responsable</label>
          <div class="sig-wrap">
            <canvas id="signRespCanvas" class="signature"></canvas>
            <span class="sig-hint">Signez ici</span>
          </div>
          <div class="sig-actions"><button class="btn-mini" type="button" onclick="clearCanvas('signRespCanvas'); saveToLocal()">Effacer</button></div>
        </div>
        <div class="sig-box">
          <label for="signSalCanvas">Signature Salari√©</label>
          <div class="sig-wrap">
            <canvas id="signSalCanvas" class="signature"></canvas>
            <span class="sig-hint">Signez ici</span>
          </div>
          <div class="sig-actions"><button class="btn-mini" type="button" onclick="clearCanvas('signSalCanvas'); saveToLocal()">Effacer</button></div>
        </div>
      </div>

      <!-- Pi√®ce jointe -->
      <div id="attachSection" class="no-break">
        <div class="section-h">PI√àCE JOINTE (photo ou PDF)</div>
        <div class="attach-box">
          <input id="attachment" type="file" accept="image/*,.pdf" multiple />
          <div class="attach-previews" id="attachPreviews"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===== Utils ===== */
const $ = s => document.querySelector(s);
const ALL_FIELDS_SELECTOR = "input[type='text'], input[type='date'], input[type='checkbox'], textarea";
function showToast(msg){ const t=$("#toast"); t.textContent=msg; t.style.display="block"; t.style.opacity="1"; setTimeout(()=>{ t.style.opacity="0"; setTimeout(()=>t.style.display="none",300); },3500); }
function todayStr(){ const d=new Date(); const m=String(d.getMonth()+1).padStart(2,'0'); const day=String(d.getDate()).padStart(2,'0'); return `${d.getFullYear()}-${m}-${day}`; }

/* ===== Textareas autogrow (UX) ===== */
function autoGrow(el){ el.classList.add('autogrow'); el.style.height='auto'; el.style.height = el.scrollHeight + 'px'; }
function bindAutoGrow(){ document.querySelectorAll('textarea').forEach(t=>{ autoGrow(t); t.addEventListener('input', ()=>autoGrow(t)); }); }

/* ===== Affichage conditionnel ===== */
["abs_prev","abs_np","ret_prev","ret_np","autre"].forEach(id=>{
  const box=$(`#${id}`), sub=$(`#${id}_fields`); if(!box||!sub) return;
  const sync=()=>{ sub.style.display=box.checked?"inline-flex":"none"; };
  box.addEventListener("change",()=>{ sync(); saveToLocal(); }); sync();
});

/* ===== Signatures (HiDPI) ===== */
function setupCanvas(id){
  const c=$(`#${id}`), ctx=c.getContext("2d");
  function fit(){
    let backup=null; try{ backup=c.toDataURL("image/png"); }catch(e){}
    const r=c.getBoundingClientRect(), dpr=window.devicePixelRatio||1;
    c.width=Math.max(1,Math.round(r.width*dpr)); c.height=Math.max(1,Math.round(r.height*dpr));
    ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr);
    ctx.fillStyle="#fff"; ctx.fillRect(0,0,r.width,r.height);
    if(backup){ const img=new Image(); img.onload=()=>ctx.drawImage(img,0,0,r.width,r.height); img.src=backup; }
    ctx.lineWidth=2; ctx.lineCap="round"; ctx.strokeStyle="#000";
  }
  function sizeCss(){ const p=c.closest('.sig-wrap'); c.style.width=p.clientWidth+"px"; c.style.height=p.clientHeight+"px"; }
  sizeCss(); fit(); window.addEventListener("resize",()=>{sizeCss();fit();});
  window.addEventListener("orientationchange",()=>setTimeout(()=>{sizeCss();fit();},250));
  let drawing=false, prev=null; const hint=c.parentElement.querySelector('.sig-hint');
  const start=(x,y)=>{ drawing=true; prev={x,y}; if(hint) hint.style.opacity='0'; };
  const move=(x,y)=>{ if(!drawing) return; ctx.beginPath(); ctx.moveTo(prev.x,prev.y); ctx.lineTo(x,y); ctx.stroke(); prev={x,y}; saveToLocalThrottled(); };
  const stop=()=>{ drawing=false; prev=null; };
  c.addEventListener("mousedown",e=>start(e.offsetX,e.offsetY));
  c.addEventListener("mousemove",e=>move(e.offsetX,e.offsetY));
  ["mouseup","mouseleave"].forEach(ev=>c.addEventListener(ev,stop));
  c.addEventListener("touchstart",e=>{ e.preventDefault(); const r=c.getBoundingClientRect(), t=e.touches[0]; start(t.clientX-r.left,t.clientY-r.top); },{passive:false});
  c.addEventListener("touchmove",e=>{ e.preventDefault(); const r=c.getBoundingClientRect(), t=e.touches[0]; move(t.clientX-r.left,t.clientY-r.top); },{passive:false});
  c.addEventListener("touchend",stop);
}
setupCanvas("signRespCanvas"); setupCanvas("signSalCanvas");

function canvasToSmallDataURL(srcCanvas,maxCssW=360,mime='image/jpeg',quality=0.9){
  const rect=srcCanvas.getBoundingClientRect();
  const src=document.createElement('canvas'); src.width=Math.max(1,Math.round(rect.width)); src.height=Math.max(1,Math.round(rect.height));
  const sctx=src.getContext('2d'); sctx.fillStyle="#fff"; sctx.fillRect(0,0,src.width,src.height); sctx.drawImage(srcCanvas,0,0,src.width,src.height);
  const ratio=Math.min(1,maxCssW/src.width), dw=Math.round(src.width*ratio), dh=Math.round(src.height*ratio);
  const off=document.createElement('canvas'); off.width=dw; off.height=dh;
  const ctx=off.getContext('2d'); ctx.fillStyle="#fff"; ctx.fillRect(0,0,dw,dh); ctx.drawImage(src,0,0,dw,dh); return off.toDataURL(mime,quality);
}

/* ===== Auto-save ===== */
const STORAGE_KEY="ficheIncidentBSM";
function collectData(includeSigs=true){
  const data={}; document.querySelectorAll(ALL_FIELDS_SELECTOR).forEach(el=>{ data[el.id]=(el.type==="checkbox")?el.checked:el.value; });
  if(includeSigs){ data.sign_resp=canvasToSmallDataURL($("#signRespCanvas")); data.sign_sal=canvasToSmallDataURL($("#signSalCanvas")); }
  return data;
}
function applyData(data){
  if(!data) return; document.querySelectorAll(ALL_FIELDS_SELECTOR).forEach(el=>{ if(!(el.id in data)) return; if(el.type==="checkbox") el.checked=!!data[el.id]; else el.value=data[el.id]||""; });
  ["abs_prev","abs_np","ret_prev","ret_np","autre"].forEach(id=>{ const b=$(`#${id}`), s=$(`#${id}_fields`); if(b&&s) s.style.display=b.checked?"inline-flex":"none"; });
  if(data.sign_resp) restoreSignature("signRespCanvas",data.sign_resp); if(data.sign_sal) restoreSignature("signSalCanvas",data.sign_sal);
}
function restoreSignature(id,dataUrl){
  if(!dataUrl) return; const c=$(`#${id}`), ctx=c.getContext("2d"); const img=new Image();
  img.onload=()=>{ const r=c.getBoundingClientRect(); ctx.fillStyle="#fff"; ctx.fillRect(0,0,r.width,r.height); ctx.drawImage(img,0,0,r.width,r.height); const h=c.parentElement.querySelector('.sig-hint'); if(h) h.style.opacity='0'; };
  img.src=dataUrl;
}
function saveToLocal(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(collectData(true))); syncToolbarPadding(); }catch(e){} }
let _saveTimer=null; function saveToLocalThrottled(){ clearTimeout(_saveTimer); _saveTimer=setTimeout(saveToLocal,300); }
function loadFromLocal(){ try{ const raw=localStorage.getItem(STORAGE_KEY); if(raw) applyData(JSON.parse(raw)); }catch(e){} }
function clearCanvas(id){ const c=document.getElementById(id), x=c.getContext("2d"); x.setTransform(1,0,0,1,0,0); x.fillStyle="#fff"; x.fillRect(0,0,c.width,c.height); const h=c.parentElement.querySelector('.sig-hint'); if(h) h.style.opacity='1'; }
function bindAutoSaveEvents(){ document.addEventListener("input", saveToLocal); document.addEventListener("change", saveToLocal); }

/* ===== Pi√®ces jointes : m√©moire + croix + clear ===== */
let attachedFiles = [];
const attachInput    = document.getElementById('attachment');
const attachPreviews = document.getElementById('attachPreviews');

if (attachInput) {
  attachInput.addEventListener('change', () => {
    const files = Array.from(attachInput.files || []);
    if (!files.length) return;
    attachedFiles = attachedFiles.concat(files);
    attachInput.value = '';
    renderAttachPreviews();
    saveToLocal();
  });
}
function renderAttachPreviews(){
  if (!attachPreviews) return;
  attachPreviews.innerHTML = '';
  attachedFiles.forEach((f, idx) => {
    const holder = document.createElement('div');
    holder.className = 'thumb';
    if (f.type.startsWith('image/')) {
      const url = URL.createObjectURL(f);
      const img = document.createElement('img'); img.src=url; holder.appendChild(img);
    } else if (f.type === 'application/pdf') {
      const span = document.createElement('span'); span.className='pdfbadge'; span.textContent='PDF joint'; holder.appendChild(span);
    } else {
      holder.textContent = f.name;
    }
    const rm=document.createElement('button'); rm.className='remove'; rm.type='button'; rm.textContent='√ó';
    rm.onclick=()=>{ attachedFiles.splice(idx,1); renderAttachPreviews(); saveToLocal(); };
    holder.appendChild(rm);
    attachPreviews.appendChild(holder);
  });
}
function clearAllAttachments(){
  attachedFiles = [];
  if (attachPreviews) attachPreviews.innerHTML = '';
  if (attachInput)    attachInput.value = '';
}

/* ===== Validation ===== */
function validateForm(){
  const missing=[];
  const responsable=($("#responsable").value||"").trim();
  const salarie=($("#salarie").value||"").trim();
  const origine=($("#origine").value||"").trim();
  const action =($("#action").value||"").trim();

  if(!responsable) missing.push("‚Ä¢ Responsable");
  if(!salarie)     missing.push("‚Ä¢ √âquipier (Fiche ouverte pour)");
  if(!origine)     missing.push("‚Ä¢ Origine de l'incident");
  if(!action)      missing.push("‚Ä¢ Action curative");

  const anyDesc = ["abs_prev","abs_np","ret_prev","ret_np","autre"].some(id => $(`#${id}`).checked);
  if(!anyDesc) missing.push("‚Ä¢ Au moins un descriptif (cocher Absence/Retard/Autre)");

  if(missing.length){
    showToast("Champs √† compl√©ter :\n" + missing.join("\n"));
    return false;
  }
  return true;
}

/* ===== PDF: helpers (PDF joints -> images, ignore page 2) ===== */
async function pdfPagesToDataURLs(file, {scale=1.8}={}){
  if(!window['pdfjsLib']) return [];
  const ab = await file.arrayBuffer();
  const doc = await pdfjsLib.getDocument({data:ab}).promise;
  const total = doc.numPages;
  const out = [];
  for(let p=1; p<=total; p++){
    if(p===2) continue;
    const page = await doc.getPage(p);
    const viewport = page.getViewport({ scale });
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = viewport.width; canvas.height = viewport.height;
    await page.render({ canvasContext: ctx, viewport }).promise;
    out.push(canvas.toDataURL('image/jpeg', 0.95));
  }
  return out;
}
function fileToDataURL(file){
  return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
}
async function getAttachmentImages(){
  const images = [];
  for(const f of attachedFiles){
    if(f.type.startsWith('image/')) images.push(await fileToDataURL(f));
    else if(f.type === 'application/pdf'){
      const pages = await pdfPagesToDataURLs(f);
      if(pages.length) images.push(...pages);
    }
  }
  return images;
}

/* ===== Pr√©-fix mobile avant capture ===== */
function preCaptureMobileFixes(){
  try{
    if (document.activeElement && typeof document.activeElement.blur === 'function') {
      document.activeElement.blur();
    }
    window.scrollTo(0,0);
  }catch(e){}
}

/* ===== PDF (A4) : styles + anti-coupures + neutralise mobile ===== */
function prepareCloneForPdf(clone){
  const style=document.createElement('style');
  style.textContent=`
    .pdf-a4{
      width:210mm!important;
      min-height:297mm!important;
      padding:8mm!important;
      box-shadow:none!important;
      border-radius:0!important;
      transform: translateZ(0);
    }
    .pdf-a4 .header{ gap:8px; margin-bottom:4px; }
    .pdf-a4 .header img{ width:38px!important; height:auto!important; }
    .pdf-a4 .header strong{ font-size:13px!important; }
    .pdf-a4 .title{ font-size:11.2px; padding:3px 5px; margin-top:0; }
    .pdf-a4 .grid{ font-size:11px; }

    /* ‚úÖ Neutraliser le responsive mobile dans le PDF */
    .pdf-a4 .grid tr{ display:table-row !important; }
    .pdf-a4 .grid td{ display:table-cell !important; width:auto !important; padding:4px 6px !important; }
    .pdf-a4 .grid tr:first-child{ display:table-row !important; grid-template-columns:none !important; }

    .pdf-a4 input, .pdf-a4 textarea{ padding:5px 7px; font-size:11px; }
    .pdf-a4 textarea{ min-height:60px!important; }
    .pdf-a4 .section-h{ padding:5px 7px; font-size:11.5px; }
    .pdf-a4 .section-b{ padding:7px; font-size:11.5px; }
    .pdf-a4 .row{ gap:5px; margin-bottom:5px; }
    .pdf-a4 .sig-wrap{ height:72px!important; }
    .pdf-a4 .signature, .pdf-a4 img.signature-img{ height:72px!important; width:100%!important; object-fit:contain; background:#fff; }

    /* Renfort anti-coupure */
    .no-break{ break-inside:avoid; page-break-inside:avoid; break-after:avoid; page-break-after:avoid; }
    .section-group, .intro-block{ break-inside:avoid; page-break-inside:avoid; }

    /* Bo√Æte simulant un input, qui retourne bien √† la ligne */
    .input-like{
      border:1.5px solid #c9ced6; border-radius:10px; padding:6px 8px;
      white-space:pre-wrap; word-break:break-word; overflow-wrap:anywhere; line-height:1.25; min-height:26px;
      font-size:11px; background:#fff;
    }
  `;
  clone.prepend(style);
  clone.classList.add('pdf-a4');

  /* Grouper ENT√äTE + TITRE + TABLE infos (indivisible) */
  const head = clone.querySelector('.header');
  const title = clone.querySelector('.title');
  const grid  = clone.querySelector('.grid');
  if (head && title && grid){
    const intro = document.createElement('div');
    intro.className = 'intro-block no-break';
    head.before(intro);
    intro.append(head, title, grid);
  }

  /* Grouper chaque section: .section-h + .section-b */
  clone.querySelectorAll('.section-h').forEach(h=>{
    const b = h.nextElementSibling;
    if(b && b.classList.contains('section-b')){
      const wrap = document.createElement('div');
      wrap.className = 'section-group no-break';
      h.before(wrap);
      wrap.append(h, b);
    }
  });

  /* ‚úÖ Remplacer tous les inputs texte & date par des blocs multi-lignes */
  clone.querySelectorAll('input[type="text"], input[type="date"]').forEach(inp=>{
    const box = document.createElement('div');
    box.className = 'input-like';
    const val = inp.value && String(inp.value).trim() ? inp.value : (inp.getAttribute('placeholder') || '');
    box.textContent = val;
    inp.replaceWith(box);
  });

  /* ‚úÖ Remplacer les canvases signatures par images statiques (wrap safe) */
  ["signRespCanvas","signSalCanvas"].forEach(id=>{
    const src=document.getElementById(id);
    if(!src) return;
    const img=document.createElement('img');
    img.src=canvasToSmallDataURL(src,500,"image/jpeg",0.9);
    img.className="signature-img";
    img.style.width="100%"; img.style.height="72px"; img.style.objectFit="contain"; img.style.background="#fff";
    const target=clone.querySelector("#"+id);
    if(target) target.replaceWith(img);
  });
}

/* Ajustement pour tenir sur 1 seule page A4 (toujours scale down) */
function fitCloneToOneA4Page(clone){
  const A4_H = 297/25.4*96;        // px css @96dpi
  const M    = 8/25.4*96;          // 8mm marges
  const fudgePx = 1;               // s√©curit√© mobile (arrondis)
  const target = A4_H - 2*M - fudgePx;
  const h = clone.scrollHeight;
  if(h > target){
    const s = target / h;
    clone.style.transformOrigin = "top left";
    clone.style.transform = `scale(${s})`;
    clone.style.width = `calc(210mm / ${s})`;
  }
}
function blobToBase64(blob){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(String(r.result).split(",")[1]||""); r.onerror=rej; r.readAsDataURL(blob); }); }

/* ===== Envoi ===== */
async function sendToServer(){
  if(!validateForm()) return;

  const WEBAPP_URL="https://otacos-proxy.contact-otacosbsm.workers.dev/";
  const loader=$("#loader"), btn=$("#sendBtn");
  try{
    btn.disabled=true; loader.style.display="flex";

    const meta={
      salarie:($("#salarie").value||"Inconnu").trim(),
      responsable:($("#responsable").value||"N/A").trim(),
      date_fiche:$("#date_fiche").value||todayStr(),
    };

    // Pr√©-fix mobile (clavier/scroll)
    preCaptureMobileFixes();

    // Clone + PJ
    const original=$("#pageContent");
    const clone = original.cloneNode(true);
    const attachImgs = await getAttachmentImages();

    // Si pas de PJ -> retirer la section du clone (ne pas l‚Äôimprimer)
    if(attachImgs.length === 0){
      const sec = clone.querySelector('#attachSection');
      if(sec) sec.remove();
    }

    // Styles PDF + regroupements + remplacements pour WRAP
    prepareCloneForPdf(clone);

    // Hors √©cran sans offset n√©gatif (√©vite vides)
    const off=document.createElement("div");
    off.style.position="fixed";
    off.style.top="0";
    off.style.left="0";
    off.style.opacity="0";
    off.style.pointerEvents="none";
    off.style.zIndex="-1";
    document.body.appendChild(off);

    off.appendChild(clone);
    fitCloneToOneA4Page(clone);   // ‚úÖ force 1 page (scale down si n√©cessaire)

    // Options PDF
    const opt={
      margin:[8,8],  // 8mm
      filename:`Fiche_Incident_${meta.salarie}_${meta.date_fiche}.pdf`,
      pagebreak:{ mode:['avoid-all'], avoid:['.no-break','.section-group','.intro-block','.section-b','.signatures','textarea'] },
      html2canvas:{ scale:2, useCORS:true, backgroundColor:"#ffffff", scrollY:0, scrollX:0, willReadFrequently:true },
      jsPDF:{ unit:"mm", format:"a4", orientation:"portrait", compress:true },
    };
    const worker=html2pdf().set(opt).from(clone).toPdf();
    const pdf=await worker.get('pdf');  // instance jsPDF

    // Ajouter les pi√®ces jointes (pleine page) √† partir de la page 2
    if(attachImgs.length){
      const a4w=210, a4h=297, margin=5;
      const innerW=a4w-2*margin, innerH=a4h-2*margin;

      for(const durl of attachImgs){
        const dims = await getImageSize(durl);
        let wmm=innerW, hmm=innerH;
        const ratio = dims.w/dims.h;
        if(wmm/hmm > ratio){ wmm = hmm*ratio; } else { hmm = wmm/ratio; }
        const x = (a4w - wmm)/2, y = (a4h - hmm)/2;
        pdf.addPage('a4','p');
        const fmt = durl.startsWith('data:image/png') ? 'PNG' : 'JPEG';
        pdf.addImage(durl, fmt, x, y, wmm, hmm);
      }
    }

    const pdfBlob = pdf.output('blob');
    off.remove();

    // Envoi au serveur
    const b64 = await blobToBase64(pdfBlob);
    const payload={ meta, b64 };
    await fetch(WEBAPP_URL,{ method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify(payload) });

    const extra = attachedFiles.length ? " Les pi√®ces jointes ont √©t√© int√©gr√©es." : "";
    showToast(`‚úÖ Merci ${meta.responsable}, la fiche incident tient sur 1 page et a √©t√© envoy√©e.${extra}`);
    saveToLocal();
  }catch(e){
    console.error(e);
    showToast("‚ùå Erreur inattendue lors de l'envoi.");
  }finally{
    loader.style.display="none"; btn.disabled=false;
  }
}

/* Helpers */
function getImageSize(dataUrl){
  return new Promise(res=>{ const img=new Image(); img.onload=()=>res({w:img.naturalWidth||img.width, h:img.naturalHeight||img.height}); img.src=dataUrl; });
}

/* ===== Clear All (inclut PJ) ===== */
function clearAll(){
  if(!confirm("Effacer tous les champs, signatures, la sauvegarde et les pi√®ces jointes ?")) return;
  document.querySelectorAll(ALL_FIELDS_SELECTOR).forEach(el=>{
    if(el.type==="checkbox") el.checked=false; else el.value="";
  });
  ["abs_prev","abs_np","ret_prev","ret_np","autre"].forEach(id=>{
    const s=$(`#${id}_fields`); if(s) s.style.display="none";
  });
  clearCanvas("signRespCanvas"); clearCanvas("signSalCanvas");
  localStorage.removeItem(STORAGE_KEY);
  clearAllAttachments();                    // efface aussi les PJ
  syncToolbarPadding();
}

/* ===== Anti-recouvrement toolbar ===== */
function syncToolbarPadding(){
  const tb=$("#toolbar");
  const h=(tb&&getComputedStyle(tb).display!=='none')?tb.offsetHeight:0;
  document.documentElement.style.setProperty('--toolbar-h', h+'px');
}
if(window.visualViewport){
  visualViewport.addEventListener('resize', syncToolbarPadding);
  visualViewport.addEventListener('scroll', syncToolbarPadding);
}

/* ===== Init ===== */
(function init(){
  bindAutoGrow();
  bindAutoSaveEvents(); loadFromLocal(); syncToolbarPadding();
  window.addEventListener('resize', syncToolbarPadding);
  window.addEventListener('orientationchange', ()=>setTimeout(syncToolbarPadding,250));
})();
</script>
</body>
</html>
